<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Living with Kubernetes</title>

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/moon.css">

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
	<section>
	  <h3>Living with Kubernetes</h3>

	  <img src="Kubernetes-logo.png"/>

	  <h6>Tristan Straub</h6>
	</section>

	<section>
	  <h3>Motivation for Kubernetes</h3>
	  <ul>
	    <li>professional experience</li>
	    <li>ubiquitous compute platform</li>
	    <li>industry wide serverless/clustered computing model</li>
	    <li>6 month project with full ci/cd pipeline
	      <ul>
		<li>migrate on premise to the cloud</li>
	      </ul>
	    </li>
	  </ul>
	</section>

	<section>
	  <h3>journey to the cloud</h3>
	  <ul>
	    <li>on premise
	      <ul>
		<li>painful non-automated deploys</li>
		<li>snowflakes everywhere</li>
		<li>release cycles</li>
	      </ul>
	    </li>
	    <li>ansible + aws, with named machines</li>
	    <li>heroku</li>
	    <li>elastic beanstalk
	      <ul>
		<li>docker</li>
		<li>cattle vs pets</li>
		<li>slow deploys</li>
		<li>machine per service -- over provisioning</li>
		<li>scaling isn't quick enough</li>
	      </ul>
	    </li>
	  </ul>
	</section>

	<section>
	  <h3>ubiquitous distributed computing platform</h3>
	  <ul>
	    <li>agents?</li>
	    <li>any hardware platform
	      <ul>
		<li>laptop</li>
		<li>mobile</li>
		<li>watch</li>
	      </ul>
	    </li>
	    <li>jvm?</li>
	    <li>browser?</li>
	    <li>docker</li>
	  </ul>
	</section>

	<section>
	  <h3>hashicorp: consul, nomad agent + nomad server</h3>
	  <img src="hashicorp.svg" style="background: white;" width="200px"/>
	  <ul>
	    <li>simple declarative description (hcl)</li>
	    <li>other tools
	      <ul>
		<li>terraform</li>
		<li>packer</li>
		<li>vagrant</li>
		<li>vault</li>
		<li>nomad</li>
	      </ul>
	    </li>
	  </ul>
	</section>

	<section>
	  <h3>Declarative (data driven) -- notable!</h3>
	  <ul>
	    <li>the things we want</li>
	    <li>specialised notation == essential ideas!</li>
	    <li>yaml, hcl, html, make (almost)</li>
	    <li>write less! apache 1 -> apache 2.0</li>
	  </ul>
	</section>

	<section>
	  <h3>6 month project -- managed platform</h3>
	  <ul>
	    <li>Azure</li>
	    <li>infrastructure as code</li>
	    <li>kafka + cassandra</li>
	    <li>compute -- intensive data streaming</li>
	    <li>CI/CD</li>
	    <li>small team</li>
	  </ul>
	</section>

	<section>
	  <h3>Leverage! -- notable!</h3>
	  <h6>Or, how to make an onion</h6>

	  <p><quote>"Give me a lever and a place to stand and I will move the earth." - Archimedes (c. 287 BC â€“ c. 212 BC)</quote></p>
	  
	  <quote>"If I have seen further it is by standing on the shoulders of Giants." - Isaac Newton, 1675.</quote>

	  <p>
	    "Grace Hopper recommended .. new programming language .. would use entirely English words" - c. 1949 (wikipedia)
	  </p>

	  <quote>Do you hear that Mr Anderson? That is the sound of inevitability - Agent Smith (The Matrix)</quote>

	  <p>collectively weaving trampoline fabric - Tristan, 11:26am Today</p>
	</section>

	<section>
	  <h3>azure</h3>
	  <ul>
	    <li>modern web portal</li>
	    <li>variety of linux boxes</li>
	    <li>data replication</li>
	    <li>cli tool (az)</li>
	    <li>con: no availability zones (Sydney)</li>
	    <li>con: two fault domains (Sydney)</li>
	    <li>con: deleting resources is slow</li>
	    <li>con: hard to find resources in portal</li>
	  </ul>
	</section>

	<section>
	  <h3>infrastructure as code (ancilliary services) -- notable!</h3>
	  <ul>
	    <li>terraform</li>
	    <li>packer</li>
	    <li>software defined infrastructure!</li>
	  </ul>
	</section>

	<section>
	  <h3>CI/CD (workflow) -- circleci -- notable!</h3>
	  <ul>
	    <li>heroku push to deploy</li>
	    <li>tdd</li>
	    <li>deploy early, deploy often</li>
	    <li>fail fast</li>
	    <li>master is always deployable</li>
	    <li>HA</li>
	    <li>rails, wiki in 20 minutes</li>	    
	  </ul>
	</section>

	<section>
	  <h3>compute infrastructure -- orchestrated</h3>
	  <ul>
	    <li>elastic beanstalk
	      <ul><li>simple, reliable</li></ul>
	    </li>
	    <li>docker swarm
	      <ul><li>felt too slapped on</li></ul>
	    </li>
	    <li>nomad
	      <ul><li>not enough community support</li></ul>
	    </li>
	    <li>aws lambda, heroku
	      <ul><li>Not azure</li></ul>
	    </li>
	    <li>kubernetes
	      <ul>
		<li>supported by large company</li>
		<li>moving fast</li>
	      </ul>
	    </li>
	  </ul>
	</section>
		
	<section>
	  <h3>Kubernetes (Greek: helmsman, steersmanship, cybernetics, Latin: gubernetes)</h3>
	  <ul>
	    <li>Uniform compute layer (like electricity!)</li>
	    <li>Master + agent nodes</li>
	    <li>Container orchestration (scheduling, availability)</li>
	    <li>Network ingress (load balancers)</li>
	    <li>Attached storage</li>
	  </ul>
	</section>

	<section>
	  <h3>everything is a container -- docker</h3>
	  <ul>
	    <li>isolation
	      <ul>
		<li>process group</li>
		<li>network stack</li>
		<li>file system</li>
	      </ul>
	    </li>
	    <li>layered file system</li>
	    <li>executable documentation</li>
	    <li>no more snowflakes!</li>
	  </ul>
	</section>

	<section>
	  <h3>getting kubernetes deployed</h3>
	  <ul>
	    <li>local environments
	      <ul>
		<li>minikube(xhyve)</li>
		<li>docker/osx kubernetes</li>
	      </ul>
	    </li>
	    <li>remote environments
	      <ul>
		<li>kops (aws)
		  <ul>
		    <li>quick to get started</li>
		    <li>played with spot instances</li>
		  </ul>
		</li>
		<li>acs-engine</li>
	      </ul>
	    </ul>
	  </ul>
	</section>

	<section>
	  <h3>acs-engine</h3>
	  <ul>
	    <li>ARM template generator</li>
	    <li>fast moving</li>
	    <li>single and multi master</li>
	    <li>https://github.com/Azure/acs-engine</li>
	    <li>Don't forget the docker registry</li>
	  </ul>
	</section>

	<section>
	  <h3>cockpit -- everything together</h3>
	  <h6>docker image with tooling</h6>
	  <ul>
	    <li>azure-cli</li>
	    <li>packer</li>
	    <li>terraform</li>
	    <li>acs-engine</li>
	    <li>kubectl, helm</li>
	    <li>docker</li>
	    <li>jq, socat, netcat, ssh, git, cqlsh, leinigen, clojure, sshuttle</li>
	  </ul>
	</section>

	<section>
	  <h3>Bootstrapping</h3>
	  <ul>
	    <li>Complete build and deploy in 60 minutes</li>
	    <li>Kubernetes + Kafka + Cassandra + Service builds and deploys</li>
	    <li>Docker based tooling -- cockpit</li>
	  </ul>
	</section>

	<section>
	  <h3>admin ingress: public master, bastion, or vpn</h3>
	  <ul>
	    <li>early acs-engine: no private clusters</li>
	    <li>circleci: not with private master</li>
	    <li>separation of production/staging</li>
	    <li>IP address space</li>
	    <li>ssh without agent forwarding
	    <pre>
Host bastion
    HostName $BASTION_IP
    User $ADMIN_USER
    IdentityFile $SSH_KEY
Host cas-*
    User $ADMIN_USER
    ProxyCommand ssh -q bastion -W %h:22
    IdentityFile $SSH_KEY
	    </pre>
	    </li>
	  </ul>
	</section>

	<section>
	  <h3>dashboard (1 of 2)</h3>
	  
	  <pre>kubectl proxy</pre>
	  <pre>Visit http://localhost:8001/ui</pre>

	  <img src="ui-dashboard.png"/>	  
	</section>

	<section>
	  <h3>dashboard (2 of 2)</h3>

	  <ul>
	    <li>Access to all kubernetes resources
	      <ul>
		<li>Nodes</li>
		<li>Namespaces</li>
		<li>Secrets</li>
		<li>ConfigMaps</li>
		<li>Pods/Containers</li>
		<li>Deployments</li>
		<li>Services
		  <ul>
		    <li>native load balancers -- internal/external</li>
		  </ul>
		</li>
	      </ul>
	  </ul>
	</section>

	<section>
	  <h3>kubectl everything</h3>
	  <ul>
	    <li>kubectl exec -it centos:7 -- /bin/bash</li>
	    <li>kubectl get nodes</li>
	    <li>kubectl get pods</li>
	    <li>kubectl expose...</li>
	    <li>kubectl apply -f yaml-file</li>
	  </ul>
	</section>

	<section>
	  <h3>yaml all the things</h3>
	  <p>kubectl apply -f yaml-file</p>
	  <pre>
apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 2
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80	    
	  </pre>
	</section>

	<section>
	  <h3>circleci</h3>
	  <ul>
	    <li>github integration</li>
	    <li>declarative config</li>
	    <li>builds + pushes docker container</li>
	    <li>talks to API Server</li>
	    <li>custom build + deploy tool</li>
	  </ul>
	</section>

	<section>
	  <h3>custom build tooling</h3>
	  <ul>
	    <li>creates remotely:
	      <ul>
		<li>Namespaces</li>
		<li>ConfigMaps</li>
		<li>Deployments</li>
		<li>Services</li>
	      </ul>
	    </li>
	    <li>"kubectl proxy" provided authorized access to kubernetes</li>
	    <li>API instead of "kubectl apply"</li>
	    <li>one config git repository</li>
	    <li>Dockerfile in each service repo</li>
	    
	  </ul>
	</section>

	<section>
	  <h3>deploys -- resource naming</h3>
	  <ul>
	    <li>Namespace -> Secrets -> ConfigMap -> Deployment -> Service</li>
	    <li>Unique ConfigMap names (prevent race!)</li>
	    <li>Docker image github SHA or unique tag</li>
	    <li>Shared service</li>
	    <li>Shared secrets
	      <ul>
		<li>tmpfs</li>
		<li>file based, or bring as environment variables.</li>
		<li>per namespace</li>
	      </ul>
	    </li>
	  </ul>
	</section>

	<section>
	  <h3>gotchas</h3>
	  <ul>
	    <li>jvm ignores memory limits</li>
	    <li>agent node is a shared resource (memory, cpu, network)</li>
	    <li>requests == limits (kswapd outage)</li>
	    <li>new deploys require memory</li>
	    <li>accomodate for machine outage</li>
	    <li>namespaces aren't enough (staging consuming production resources)</li>
	  </ul>
	</section>
	
	<section>
	  <h3>Observations and recommendations</h3>
	  <ul>
	    <li>kubernetes is a moving target</li>
	    <li>many deprecated options</li>
	    <li>too many service mesh options</li>
	  </ul>
	</section>

	<section>
	  <h3>Next steps</h3>
	  <ul>
	    <li>use kubernetes as a managed service
	      <ul>
		<li>EKS</li>
		<li>AKS</li>
		<li>GCE</li>
	      </ul>
	    </li>
	    <li>spinnaker -- orchestration (not a build server)</li>
	    <li>jenkins, jenkinsx</li>
	    <li>service mesh</li>
	    <li>Rancher</li>
	    <li>operators for stateful services</li>
	  </ul>
	</section>

	<section>
	  <h3>Thank you!</h3>
	</section>
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
      // More info about config & dependencies:
      // - https://github.com/hakimel/reveal.js#configuration
      // - https://github.com/hakimel/reveal.js#dependencies
      Reveal.initialize({
      dependencies: [
      { src: 'plugin/markdown/marked.js' },
      { src: 'plugin/markdown/markdown.js' },
      { src: 'plugin/notes/notes.js', async: true },
      { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
      ]
      });
    </script>
  </body>
</html>
